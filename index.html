<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Emotion Sphere (Google Vision)</title>
  <style>
    /* ================= ê¸°ë³¸ ìŠ¤íƒ€ì¼ ================= */
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
      background: #000;
      height: 100%;
      font-family: sans-serif;
      /* ë“œë˜ê·¸ ë° ì„ íƒ ë°©ì§€ (í‚¤ì˜¤ìŠ¤í¬ ëª¨ë“œìš©) */
      user-select: none;
      -webkit-user-select: none;
    }
    #container {
      width: 100vw;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* ================= ìƒë‹¨ UI (ì •ë³´ ë° ì œì–´) ================= */
    #ui {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 100; /* Three.js ë³´ë‹¤ ìœ„ì— */
      color: #fff;
      font-size: 14px;
      width: 300px;
      line-height: 1.6;
      background: rgba(0, 0, 0, 0.5); /* ë°°ê²½ ë°˜íˆ¬ëª… */
      padding: 15px;
      border-radius: 12px;
      backdrop-filter: blur(5px); /* ë¸”ëŸ¬ íš¨ê³¼ */
    }
    /* ìƒë‹¨ ì‘ì€ ë²„íŠ¼ë“¤ */
    .control-btn {
      padding: 8px 12px;
      margin-right: 8px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .control-btn:hover, .control-btn:active {
      background: rgba(255, 255, 255, 0.4);
    }
    #info {
      white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ë³´ì¡´ */
    }

    /* ================= ìš°ì¸¡ í•˜ë‹¨ ì¹´ë©”ë¼ ì„¹ì…˜ ================= */
    #camera-section {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 110;
      display: flex;
      flex-direction: column;
      align-items: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
      gap: 15px; /* ë²„íŠ¼ê³¼ ì¹´ë©”ë¼ ì‚¬ì´ ê°„ê²© */
    }

    /* 1) í¬ê³  ì•„ë¦„ë‹¤ìš´ ì´¬ì˜ ë²„íŠ¼ */
    #snapBtn {
      padding: 20px 40px; /* í¬ê¸° ëŒ€í­ í™•ëŒ€ */
      border-radius: 50px; /* ë‘¥ê·¼ ì•Œì•½ ëª¨ì–‘ */
      border: none;
      background: linear-gradient(135deg, #ff6b6b, #f06595); /* ëˆˆì— ë„ëŠ” ê·¸ë¼ë°ì´ì…˜ */
      color: #fff;
      font-size: 24px; /* ê¸€ì í¬ê¸° í™•ëŒ€ */
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
      transition: transform 0.2s, box-shadow 0.2s;
      /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
      white-space: nowrap;
    }
    #snapBtn:active {
      transform: scale(0.95); /* í´ë¦­ ì‹œ ì‚´ì§ ëˆŒë¦¬ëŠ” íš¨ê³¼ */
      box-shadow: 0 2px 10px rgba(255, 107, 107, 0.4);
      background: linear-gradient(135deg, #fa5252, #e64980);
    }

    /* 2) ì¹´ë©”ë¼ ë˜í¼ (ë¹„ë””ì˜¤ + ê°€ì´ë“œë¼ì¸) */
    #camera-wrapper {
      position: relative;
      width: 400px;  /* ë„ˆë¹„ í™•ëŒ€ */
      height: 300px; /* ë†’ì´ í™•ëŒ€ */
      border-radius: 20px;
      overflow: hidden;
      border: 3px solid rgba(255, 255, 255, 0.5);
      background: #222;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }

    /* ì‹¤ì œ ë¹„ë””ì˜¤ í™”ë©´ */
    #cam {
      width: 100%;
      height: 100%;
      object-fit: cover; /* í™”ë©´ ê½‰ ì±„ìš°ê¸° */
      transform: scaleX(-1); /* ê±°ìš¸ëª¨ë“œ (ì¢Œìš°ë°˜ì „) */
    }

    /* ì–¼êµ´ ê°€ì´ë“œë¼ì¸ ì˜¤ë²„ë ˆì´ */
    #face-guide {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 45%;  /* ê°€ì´ë“œ ë„ˆë¹„ */
      height: 70%; /* ê°€ì´ë“œ ë†’ì´ */
      border: 4px dashed rgba(255, 255, 255, 0.7); /* ì ì„  í…Œë‘ë¦¬ */
      border-radius: 50% 50% 60% 60%; /* ì•½ê°„ ë‹¬ê±€í˜• íƒ€ì› */
      box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
      pointer-events: none; /* í´ë¦­ í†µê³¼ë˜ë„ë¡ ì„¤ì • */
    }

    /* ìº¡ì³ìš© ìˆ¨ê¹€ ìº”ë²„ìŠ¤ */
    #snap { display: none; }

  </style>
</head>
<body>

<div id="container"></div>

<div id="ui">
  <div>
    <button id="startBtn" class="control-btn">ì¹´ë©”ë¼ ì¼œê¸°</button>
    <button id="stopBtn" class="control-btn">ì¹´ë©”ë¼ ë„ê¸°</button>
  </div>
  <div id="info">ì™¼ìª½ ìœ„ ë²„íŠ¼ìœ¼ë¡œ ì¹´ë©”ë¼ë¥¼ ì¼œì£¼ì„¸ìš”.</div>
</div>

<div id="camera-section">
  <button id="snapBtn">ğŸ“¸ ì‚¬ì§„ ì°ê³  ë¶„ì„í•˜ê¸°</button>
  
  <div id="camera-wrapper">
    <video id="cam" autoplay playsinline muted></video>
    <div id="face-guide"></div> </div>
</div>

<canvas id="snap" width="640" height="480"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
/* ===========================================================
    ì¤‘ìš”: ì„œë²„ ì£¼ì†Œ ì„¤ì •
    (ë‚˜ì¤‘ì— Cloud Run ë°°í¬ í›„ ì—¬ê¸°ì— ì£¼ì†Œë¥¼ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.)
=========================================================== */
// ì„ì‹œ ì£¼ì†Œ (ë‚˜ì¤‘ì— êµì²´ í•„ìˆ˜)
const SERVER_URL = "https://kylie-uninforming-sighingly.ngrok-free.dev/analyze";


/* ===========================================================
    1) ì¹´ë©”ë¼ ì œì–´
=========================================================== */
let stream = null;

async function startCamera() {
  const info = document.getElementById("info");
  const video = document.getElementById("cam");

  try {
    // íƒœë¸”ë¦¿ í›„ë©´ ì¹´ë©”ë¼ ëŒ€ì‹  ì „ë©´(ì…€ì¹´) ì¹´ë©”ë¼ ìš°ì„  ìš”ì²­
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user", width: 640, height: 480 }
    });
    video.srcObject = stream;
    info.innerHTML = "ì¹´ë©”ë¼ê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤.<br>ê°€ì´ë“œë¼ì¸ì— ì–¼êµ´ì„ ë§ì¶”ê³ <br>ìš°ì¸¡ í•˜ë‹¨ ğŸ“¸ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.";
  } catch (e) {
    info.textContent = "ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + e.message + "\n(HTTPS í™˜ê²½ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”)";
    alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨. HTTPS ì ‘ì†ì´ í•„ìš”í•©ë‹ˆë‹¤.");
  }
}

function stopCamera() {
  const info = document.getElementById("info");
  const video = document.getElementById("cam");
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
    video.srcObject = null;
    info.textContent = "ì¹´ë©”ë¼ê°€ êº¼ì¡ŒìŠµë‹ˆë‹¤.";
  }
}


/* ===========================================================
    2) ì‚¬ì§„ ìº¡ì³ â†’ ì„œë²„ ì „ì†¡ â†’ ê²°ê³¼ ì²˜ë¦¬
=========================================================== */
async function snapAndAnalyze() {
  const info = document.getElementById("info");
  const video = document.getElementById("cam");
  const canvas = document.getElementById("snap");
  const ctx = canvas.getContext("2d");
  const snapBtn = document.getElementById("snapBtn");

  if (!stream || !video.srcObject) {
    alert("ë¨¼ì € 'ì¹´ë©”ë¼ ì¼œê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!");
    return;
  }

  // ë²„íŠ¼ ì¤‘ë³µ í´ë¦­ ë°©ì§€ ë° í”¼ë“œë°±
  snapBtn.disabled = true;
  const originalBtnText = snapBtn.innerHTML;
  snapBtn.innerHTML = "â³ ë¶„ì„ ì¤‘...";
  snapBtn.style.background = "#999";

  // ìº”ë²„ìŠ¤ì— í˜„ì¬ ë¹„ë””ì˜¤ í™”ë©´ ê·¸ë¦¬ê¸°
  // (ì¢Œìš°ë°˜ì „ëœ ë¹„ë””ì˜¤ë¥¼ ë‹¤ì‹œ ë°˜ì „ì‹œì¼œì„œ ì •ë°©í–¥ìœ¼ë¡œ ìº¡ì³)
  ctx.save();
  ctx.scale(-1, 1);
  ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
  ctx.restore();

  info.textContent = "ì´ë¯¸ì§€ ìº¡ì³ ì™„ë£Œ. ì„œë²„ ì „ì†¡ ì¤€ë¹„...";

  canvas.toBlob(async blob => {
    if (!blob) {
      info.textContent = "ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨";
      resetButton();
      return;
    }

    info.textContent = "â˜ï¸ ì„œë²„ë¡œ ì´ë¯¸ì§€ ì „ì†¡ ì¤‘...";

    const form = new FormData();
    form.append("frame", blob, "frame.jpg");

    try {
      // 1. ì„œë²„ ìš”ì²­
      const res = await fetch(SERVER_URL, { method: "POST", body: form });

      // 2. ì‘ë‹µ ì²˜ë¦¬
      if (!res.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜ (HTTP ${res.status})`);
      
      const data = await res.json(); // ë°”ë¡œ JSONìœ¼ë¡œ íŒŒì‹±

      if (data.status !== "ok") {
        throw new Error(data.error || data.detail || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
      }

      // 3. ì„±ê³µ ì‹œ ì •ë³´ í‘œì‹œ ë° êµ¬ ì—…ë°ì´íŠ¸
      info.innerHTML = "âœ… ë¶„ì„ ì„±ê³µ!\n" +
                       "ê°ì • ê²°ê³¼ê°€ êµ¬ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n" +
                       JSON.stringify(data.emotions, null, 2);

      updateSphereFromEmotion(data);

    } catch (err) {
      console.error(err);
      info.textContent = "âŒ ë¶„ì„ ì‹¤íŒ¨:\n" + err.message;
      // ì•„ì§ ì„œë²„ê°€ ì—†ì„ ë•Œë¥¼ ìœ„í•œ ì•ˆë‚´
      if(err.message.includes("Failed to fetch")) {
        info.textContent += "\n\n(í˜„ì¬ ì„œë²„ ì£¼ì†Œê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nHTML ì½”ë“œì˜ SERVER_URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.)";
      }
    } finally {
      // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
      resetButton();
    }
  }, "image/jpeg", 0.95);

  function resetButton() {
    snapBtn.disabled = false;
    snapBtn.innerHTML = originalBtnText;
    snapBtn.style.background = ""; // ì›ë˜ ê·¸ë¼ë°ì´ì…˜ìœ¼ë¡œ ë³µê·€
  }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.getElementById("startBtn").addEventListener("click", startCamera);
document.getElementById("stopBtn").addEventListener("click", stopCamera);
document.getElementById("snapBtn").addEventListener("click", snapAndAnalyze);


/* ===========================================================
    3) Three.js ê°ì • êµ¬ (ì‹œê°í™”)
=========================================================== */
let scene, camera, renderer, geometry, points, basePositions;

function initThree() {
  const container = document.getElementById("container");
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000000);

  const W = window.innerWidth;
  const H = window.innerHeight;

  // ì¹´ë©”ë¼ ì‹œì  ì¡°ì •
  camera = new THREE.PerspectiveCamera(45, W / H, 0.1, 100);
  camera.position.set(0, 0, 8); // êµ¬ë¥¼ ì¢€ ë” ì˜ ë³´ì´ê²Œ ê±°ë¦¬ ì¡°ì •

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(W, H);
  renderer.setPixelRatio(window.devicePixelRatio); // ê³ í•´ìƒë„ ë””ìŠ¤í”Œë ˆì´ ëŒ€ì‘
  container.appendChild(renderer.domElement);

  // ì  ê°œìˆ˜ ì¦ê°€ (ë” ë°€ë„ ë†’ê²Œ)
  const count = 3000;
  const positions = new Float32Array(count * 3);
  const colors = new Float32Array(count * 3);
  const R = 1.8; // ê¸°ë³¸ êµ¬ í¬ê¸° í™•ëŒ€

  for (let i = 0; i < count; i++) {
    // Fibonacci Sphere ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ì ë“¤ì„ êµ¬ í‘œë©´ì— ê· ë“±í•˜ê²Œ ë°°ì¹˜
    const goldenRatio = (1 + Math.sqrt(5)) / 2;
    const theta = 2 * Math.PI * i / goldenRatio;
    const phi = Math.acos(1 - 2 * (i + 0.5) / count);

    const x = R * Math.sin(phi) * Math.cos(theta);
    const y = R * Math.sin(phi) * Math.sin(theta);
    const z = R * Math.cos(phi);

    positions[i * 3] = x;
    positions[i * 3 + 1] = y;
    positions[i * 3 + 2] = z;

    // ì´ˆê¸° ìƒ‰ìƒ: ì•½ê°„ í‘¸ë¥¸ë¹› ë„ëŠ” í°ìƒ‰
    colors[i * 3] = 0.8;
    colors[i * 3 + 1] = 0.9;
    colors[i * 3 + 2] = 1.0;
  }

  basePositions = positions.slice();

  geometry = new THREE.BufferGeometry();
  geometry.setAttribute("position", new THREE.BufferAttribute(positions, 3));
  geometry.setAttribute("color", new THREE.BufferAttribute(colors, 3));

  // ì  ì¬ì§ˆ ì„¤ì •
  const material = new THREE.PointsMaterial({
    size: 0.035, // ì  í¬ê¸° ì•½ê°„ í™•ëŒ€
    vertexColors: true,
    transparent: true,
    opacity: 0.9,
    blending: THREE.AdditiveBlending // ë¹›ë‚˜ëŠ” íš¨ê³¼
  });

  points = new THREE.Points(geometry, material);
  scene.add(points);

  window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
}

function animate() {
  requestAnimationFrame(animate);
  if (points) {
    // ì²œì²œíˆ ìì „
    points.rotation.y += 0.0015;
    points.rotation.x += 0.0005;
  }
  renderer.render(scene, camera);
}

initThree();
animate();


/* ===========================================================
    4) ê°ì • ë°ì´í„° â†’ êµ¬ ì‹œê°í™” ë§¤í•‘ í•¨ìˆ˜
=========================================================== */
function updateSphereFromEmotion(data) {
  if (!geometry || !data.emotions) return;

  const { joy, sorrow, anger, surprise } = data.emotions;
  // valence: ê¸ì •(>0) vs ë¶€ì •(<0)
  // arousal: í¥ë¶„(>0) vs ì°¨ë¶„(0ì— ê°€ê¹Œì›€)
  const valence = data.valence;
  const arousal = data.arousal;

  // 1. í¬ê¸° ë³€í™” (Valence ê¸°ë°˜)
  // ê¸ì •ì ì¼ìˆ˜ë¡ ì»¤ì§ (ê¸°ë³¸ 1.0ë°° ~ ìµœëŒ€ 1.5ë°°)
  let targetScale = 1.0 + (valence * 0.5);
  // ë¶€ì •ì ì¼ìˆ˜ë¡ ì•½ê°„ ì‘ì•„ì§ (ìµœì†Œ 0.8ë°°)
  if (valence < 0) targetScale = 1.0 + (valence * 0.2);
  
  // ë¶€ë“œëŸ¬ìš´ í¬ê¸° ë³€í™”ë¥¼ ìœ„í•´ GSAP ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì“°ë©´ ì¢‹ì§€ë§Œ,
  // ì§€ê¸ˆì€ ê°„ë‹¨í•˜ê²Œ ë°”ë¡œ ì ìš©í•©ë‹ˆë‹¤.
  points.scale.set(targetScale, targetScale, targetScale);


  // 2. ì ë“¤ì˜ ì›€ì§ì„ (Jitter) ë° ìƒ‰ìƒ ë³€í™”
  const positions = geometry.attributes.position;
  const colors = geometry.attributes.color;
  const count = positions.count;

  // Arousal(í¥ë¶„ë„)ê°€ ë†’ì„ìˆ˜ë¡ ì§„í­(jitterAmp)ê³¼ ì†ë„(timeSpeed) ì¦ê°€
  const jitterAmp = 0.02 + (arousal * 0.15); 
  const timeSpeed = 1.0 + (arousal * 3.0);
  const t = performance.now() * 0.001 * timeSpeed;

  for (let i = 0; i < count; i++) {
    const i3 = i * 3;
    const bx = basePositions[i3];
    const by = basePositions[i3 + 1];
    const bz = basePositions[i3 + 2];

    // ë…¸ì´ì¦ˆ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶ˆê·œì¹™í•œ ì›€ì§ì„ ìƒì„± (ê°„ì´ êµ¬í˜„)
    // ê° ì ë§ˆë‹¤ ì¡°ê¸ˆì”© ë‹¤ë¥¸ ìœ„ìƒì„ ì¤˜ì„œ ì¼ë ì´ëŠ” ëŠë‚Œ
    const noiseX = Math.sin(t * 1.1 + by * 2.5 + bz * 1.3);
    const noiseY = Math.cos(t * 1.3 + bx * 2.2 + bz * 1.7);
    const noiseZ = Math.sin(t * 1.7 + bx * 1.9 + by * 2.1);

    positions.array[i3]     = bx + noiseX * jitterAmp;
    positions.array[i3 + 1] = by + noiseY * jitterAmp;
    positions.array[i3 + 2] = bz + noiseZ * jitterAmp;

    // --- ìƒ‰ìƒ ë§¤í•‘ ë¡œì§ ê°œì„  ---
    // ê¸°ë³¸ ë² ì´ìŠ¤: ì¤‘ë¦½ì ì¸ íšŒìƒ‰/í°ìƒ‰
    let r = 0.6, g = 0.6, b = 0.7;

    if (valence >= 0) {
      // ê¸ì •ì  (Joy) -> ë…¸ë‘/ì£¼í™© ê³„ì—´
      r += joy * 0.4;
      g += joy * 0.3;
      b -= joy * 0.2; // íŒŒë‘ì„ ë¹¼ì„œ ë”°ëœ»í•˜ê²Œ
    } else {
      // ë¶€ì •ì  (Sorrow, Anger) -> íŒŒë‘/ë³´ë¼/ë¹¨ê°• ê³„ì—´
      const neg = Math.abs(valence);
      r += anger * 0.5;    // í™”ë‚¨ -> ë¹¨ê°• ì¶”ê°€
      b += sorrow * 0.5;   // ìŠ¬í”” -> íŒŒë‘ ì¶”ê°€
      g -= neg * 0.3;      // ì´ˆë¡ì„ ë¹¼ì„œ ì–´ë‘¡ê±°ë‚˜ ê°•ë ¬í•˜ê²Œ
    }

    // Surprise/Arousalì´ ë†’ìœ¼ë©´ ì „ì²´ì ìœ¼ë¡œ ë°ê³  í•˜ì–—ê²Œ ë¹›ë‚¨ (ì±„ë„ ê°ì†Œ, ëª…ë„ ì¦ê°€)
    const boost = (surprise + arousal) * 0.4;
    r = Math.min(1.0, r + boost);
    g = Math.min(1.0, g + boost);
    b = Math.min(1.0, b + boost);

    colors.array[i3]     = r;
    colors.array[i3 + 1] = g;
    colors.array[i3 + 2] = b;
  }

  positions.needsUpdate = true;
  colors.needsUpdate = true;
}
</script>
</body>
</html>

